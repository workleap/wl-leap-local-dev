trigger:
  branches:
    include:
      - renovate/*
      
resources:
  repositories:
    - repository: templates
      type: git
      name: Shared-Assets/Pipeline-Library
      ref: refs/tags/1.9.1

jobs:
  - job: build
    pool:
      vmImage: ubuntu-latest

    steps:
      - checkout: self
        clean: true
        fetchDepth: 0

      - task: UseDotNet@2
        displayName: "Install .NET SDK from global.json"
        inputs:
          packageType: "sdk"
          useGlobalJson: true

      - task: UseDotNet@2
        displayName: "Install .NET 8.0 SDK"
        inputs:
          packageType: sdk
          version: "8.0.x"

      - template: templates/install-mkcert.yml

      - task: AzureCLI@2
        displayName: "build and test"
        inputs:
          azureSubscription: "ARM - gsoft-idp-dev"
          scriptType: pscore
          scriptLocation: scriptPath
          scriptPath: "./Build.ps1"

      - task: NuGetAuthenticate@1
        displayName: "NuGet authenticate"

      - task: NuGetCommand@2
        displayName: "NuGet push"
        inputs:
          command: push
          publishVstsFeed: "gsoftdev"
          packagesToPush: "./.output/*.nupkg"
          allowPackageConflicts: true

      - task: PublishPipelineArtifact@1
        displayName: "Publish built artifacts"
        inputs:
          targetPath: "./.output/"
          artifactName: LeapNugetPackage

  - job: test
    dependsOn: build
    timeoutInMinutes: 10
    strategy:
      matrix:
        linux:
          imageName: "ubuntu-latest"
        macos:
          imageName: "macOS-latest"
        windows:
          imageName: "windows-latest"
    pool:
      vmImage: $(imageName)

    steps:
      - checkout: self
        clean: true
        fetchDepth: 1

      - task: UseDotNet@2
        displayName: "Install .NET SDK from global.json"
        inputs:
          packageType: sdk
          useGlobalJson: true

      - task: UseDotNet@2
        displayName: "Install .NET 8.0 SDK"
        inputs:
          packageType: sdk
          version: "8.0.x"

      - task: DownloadPipelineArtifact@2
        displayName: "Download built artifacts"
        inputs:
          artifact: LeapNugetPackage
          targetPath: "./.output/"

      - pwsh: "./Install.ps1"
        displayName: "Install Leap"

      - template: templates/install-mkcert.yml

      - template: templates/leap-run.yml

  - job: linearb
    pool: idp
    variables:
      - group: LinearB
    dependsOn: test
    steps:
    - template: steps/linearb/linearb-deployment.yaml@templates
      parameters:
        Environment: developement
