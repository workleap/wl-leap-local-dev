trigger:
  branches:
    include:
      - main
  paths:
    include:
      - /src/*
  tags:
    include:
      - "*.*.*"

pool:
  vmImage: ubuntu-latest

steps:
  - checkout: self
    clean: true
    fetchDepth: 0

  - task: UseDotNet@2
    displayName: "Use .NET SDK"
    inputs:
      packageType: sdk
      useGlobalJson: true

  - script: |
      dotnet workload install aspire
    displayName: Install Aspire workload

  - task: PowerShell@2
    displayName: "Restore, build, test and pack"
    inputs:
      targetType: "filePath"
      filePath: "Build.ps1"
      pwsh: true

  - task: NuGetAuthenticate@1
    displayName: "NuGet authenticate"

  - task: NuGetCommand@2
    displayName: "NuGet Push"
    inputs:
      command: push
      publishVstsFeed: "gsoft"
      packagesToPush: ".output/*.nupkg"
      allowPackageConflicts: false
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
