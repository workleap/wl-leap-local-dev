trigger:
  branches:
    include:
      - main
  paths:
    include:
      - /src/*
  tags:
    include:
      - "*.*.*"

pool:
  vmImage: ubuntu-latest

variables:
  - group: LinearB

resources:
  repositories:
    - repository: templates
      type: git
      name: Shared-Assets/Pipeline-Library
      ref: refs/tags/0.5.0

steps:
  - checkout: self
    clean: true
    fetchDepth: 0

  - task: UseDotNet@2
    displayName: "Use .NET SDK"
    inputs:
      packageType: sdk
      useGlobalJson: true

  - script: |
      dotnet workload install aspire
    displayName: Install Aspire workload

  - task: PowerShell@2
    displayName: "Restore, build, test and pack"
    inputs:
      targetType: "filePath"
      filePath: "Build.ps1"
      pwsh: true

  - task: NuGetAuthenticate@1
    displayName: "NuGet authenticate"

  - task: NuGetCommand@2
    displayName: "NuGet Push"
    inputs:
      command: push
      publishVstsFeed: "gsoft"
      packagesToPush: ".output/*.nupkg"
      allowPackageConflicts: false

  - template: steps/linearb/linearb-deployment.yaml@templates
    parameters:
    ${{ if startsWith(variables['Build.SourceBranch'], 'refs/tags/')}}
      Environment: release
    ${{ else }}
      Environment: staging
